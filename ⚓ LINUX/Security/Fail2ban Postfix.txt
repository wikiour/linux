Fail2ban Защита Postfix

* Настройка Fail2Ban для мониторинга журналов Postfix
* Здесь описаны все необходимые фильтры для Postfix

[postfix]       - Блокировка пересылки через Ваш почтовый сервер
[postfix-sasl]  - Блокировка подбора логина и пароля при использовании SASL-аутентификации


Важно! Следите за тем, чтобы путь к файлу хранения логов logpath был указан корректно. 
Обязательно назначьте ему необходимые права доступа командой chmod 755 /var/log/XXX.log
* У вас должны быть определены базовые параметры [DEFAULT] в jail.local

*** Конфигурация Fail2ban настраивается

--- $ nano /etc/fail2ban/jail.local

*** Управление активными фильтрами

--- $ cd /etc/fail2ban/filter.d



*** Блокировка пересылки через Ваш почтовый сервер

--- jail.local -------------------------------------------------------------------
----------------------------------------------------------------------------------
[postfix]

enabled  = true
port     = smtp,ssmtp,submission
filter   = postfix
logpath  = /var/log/maillog
-----------------------------------------------------------------------------------
--- postfix.conf ------------------------------------------------------------------
-----------------------------------------------------------------------------------
Фильтр nginx-limit-req.conf существует по умолчанию в фильтрах
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------


*** Блокировка подбора логина и пароля при использовании SASL-аутентификации

--- jail.local -------------------------------------------------------------------
----------------------------------------------------------------------------------
[postfix-sasl]

enabled   = true
port      = smtp,ssmtp,submission,imap2,imap3,imaps,pop3,pop3s
filter    = postfix-sasl
logpath   = /var/log/maillog
-----------------------------------------------------------------------------------
--- postfix-sasl.conf ------------------------------------------------------------------
-----------------------------------------------------------------------------------
[INCLUDES]

before    = common.conf

[Definition]

_daemon   = postfix/smtpd

failregex = ^%(__prefix_line)swarning: [-._\w]+\[<HOST>\]: SASL (?:LOGIN|PLAIN|(?:CRAM|DIGEST)-MD5) authentication failed(: [ A-Za-z0-9+/]*={0,2})?\s*$

ignoreregex =
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------


--- Проверка срабатывания правил --------------------------------------------------------
-----------------------------------------------------------------------------------------
*** Проверка срабатывания правил
--- $ fail2ban-regex /var/log/ХХХ.log /etc/fail2ban/filter.d/ХХХ.conf

*** В случае проблем, логи можно посмотреть следующим образом
--- $ tail -F /var/log/fail2ban.log
--- $ Cntr + Z выйти

*** После внесения изменений в jail.local
* Проверить состояние fail2ban
--- $ systemctl status fail2ban
* Перезапустить сервис
--- $ service fail2ban restart
* Получение информации о включенных джейлах
--- $ fail2ban-client status

