Fail2ban Защита MySQL и phpMyAdmin

* Настройка Fail2Ban для мониторинга журналов MySQL и phpMyAdmin
* Здесь описаны все необходимые фильтры для MySQL и phpMyAdmin

[mysqld-auth]        - Защита MySQL 
[phpmyadmin-syslog]  - Защита phpMyAdmin


Важно! Следите за тем, чтобы путь к файлу хранения логов logpath был указан корректно. 
Обязательно назначьте ему необходимые права доступа командой chmod 755 /var/log/XXX.log
* У вас должны быть определены базовые параметры [DEFAULT] в jail.local

*** Конфигурация Fail2ban настраивается

--- $ nano /etc/fail2ban/jail.local

*** Управление активными фильтрами

--- $ cd /etc/fail2ban/filter.d



*** Защита MySQL с помощью Fail2Ban 

--- jail.local --------------------------------------------------------------------
-----------------------------------------------------------------------------------
[mysqld-auth]

enabled  = true
port     = 3306
filter   = mysqld-auth
logpath  = /var/log/mysql/error.log
-----------------------------------------------------------------------------------
--- mysqld-auth.conf --------------------------------------------------------------
-----------------------------------------------------------------------------------
Фильтр mysqld-auth.conf существует по умолчанию в фильтрах
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
*** Проверка срабатывания правил
--- $ fail2ban-regex /var/log/mysql/error.log /etc/fail2ban/filter.d/mysqld-auth.conf 


*** Защита phpMyAdmin с помощью Fail2Ban 

--- jail.local --------------------------------------------------------------------
-----------------------------------------------------------------------------------
[phpmyadmin-syslog]

enabled  = true
port     = 3306
filter   = phpmyadmin-syslog
logpath  = /var/log/auth.log
-----------------------------------------------------------------------------------
--- phpmyadmin-syslog.conf --------------------------------------------------------
-----------------------------------------------------------------------------------
Фильтр phpmyadmin-syslog.conf существует по умолчанию в фильтрах
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
*** Проверка срабатывания правил
--- $ fail2ban-regex /var/log/auth.log /etc/fail2ban/filter.d/phpmyadmin-syslog.conf



* Дополнительный общий фильтр который можно расширять разными запросами

----------------------------------------------------------------------------------
--- jail.local -------------------------------------------------------------------
----------------------------------------------------------------------------------
[sql-ban]

enabled   = true
port      = http,https
filter    = sql-ban
logpath   = /var/log/apache2/access.log или /var/log/nginx/access.log
-----------------------------------------------------------------------------------
--- sql-ban.conf -----------------------------------------------------------------
-----------------------------------------------------------------------------------
[Definition]

failregex = ^<HOST> -.*GET.*(/admin/mysql/index\.php)
            ^<HOST> -.*GET.*(/admin/phpMyAdmin/index\.php)
            ^<HOST> -.*GET.*(/mysql-admin/index\.php)
            ^<HOST> -.*GET.*(/mysqladmin/index\.php)
            ^<HOST> -.*GET.*(/phpadmin/index\.php)
            ^<HOST> -.*GET.*(/phpMyAdmin/index\.php)

ignoreregex =
-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
*** Проверка срабатывания правил
--- $ fail2ban-regex /var/log/XXXXXXX/access.log /etc/fail2ban/filter.d/sql-ban.conf




*** После внесения изменений в fail2ban

* Проверить состояние fail2ban
--- $ systemctl status fail2ban

* Перезапустить сервис
--- $ service fail2ban restart

* Получение информации о включенных джейлах
--- $ fail2ban-client status
